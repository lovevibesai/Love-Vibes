Love Vibes: Master System Blueprint (As-Built)
Status: Production Ready Version: 1.0.0 Date: 2026-01-18

This document is the definitive technical specification of the currently implemented "Love Vibes" platform. It reflects the actual code structure, database schema, and logic engines deployed in the src/ directory.

1. System Architecture
The platform runs entirely on the Cloudflare Stack, ensuring global low-latency and infinite scalability.

Component	Technology	Implementation File	Purpose
API Gateway	Cloudflare Workers	
src/index.ts
Routes requests, handles CORS, and Enforces Auth.
Identity	JWT (HS256)	
src/auth.ts
Secure stateless authentication using jose library.
Database	Cloudflare D1 (SQLite)	
schema.sql
Relational data: Users, Matches, Gifts, Swipes.
Geosharding	S2 Geometry + KV	
src/feed.ts
Spatial indexing for "Who is near me?".
Real-time	Durable Objects	
src/durable_objects.ts
Stateful WebSocket servers for Chat Rooms.
Object Store	Cloudflare R2	
wrangler.toml
Storage for User Photos and 15s Video Intros.
2. Core Engines (The Logic)
2.1 The "Love Vibes" Feed Engine
File: 
src/feed.ts
 Algorithm:

Locate: User's Lat/Long is converted to a Level 12 S2 Cell ID using s2-geometry.
Filter (The Vibe Check):
Checks User.mode (Dating vs Friendship).
If mode == FRIENDSHIP, the query only returns other users in Friendship mode.
Deduplicate: Excludes users already swiped (SELECT * FROM Swipes WHERE actor_id = ?).
2.2 The Matching Engine
File: 
src/swipe.ts
 Logic:

Atomic Write: Records every Swipe (LIKE or PASS) to D1.
Mutual Detection: On every LIKE, it performs an inverse check:
SELECT * FROM Swipes WHERE actor_id = Target AND target_id = Me AND type = 'LIKE'
Match Creation: If mutual, creates a 
Match
 record and assigns a unique Durable Object ID for the chat room.
2.3 The Real-Time Chat Engine
File: 
src/durable_objects.ts
 Class: 
ChatRoom
 Behavior:

WebSocket Upgrade: Upgrades HTTP requests to persistent WS connections.
Broadcast: Relays messages (text, image, gift) to all connected sockets in the room instantly.
Persistence: Messages are stored asynchronously to D1 for history.
2.4 The Gifting Engine
File: 
src/gifting.ts
 Logic:

Atomic Transaction: Uses D1 Batch execution to ensure consistency.
UPDATE Users SET credits_balance = credits_balance - Cost
INSERT INTO Gifts (...)
Validation: Prevents negative balances.
3. Data Schema (The "Truth")
Reflecting 
schema.sql
 and 
LoveVibes.proto
.

Users Table
Column	Type	Description
id	TEXT	UUID (Primary Key)
phone_number	TEXT	Auth Identity
s2_cell_id	TEXT	Geosharding Key (Level 12)
mode	INT	Love Vibes Unique: 0=Dating, 1=Friendship
trust_score	INT	Love Vibes Unique: 0-100 Reputation
is_verified	BOOL	Selfie Verification Status
credits_balance	INT	Love Vibes Unique: Virtual Currency
video_intro_url	TEXT	Love Vibes Unique: R2 URL for 15s Video
Swipes Table
actor_id, target_id, type ('LIKE'/'PASS'), timestamp
Matches Table
id, user_a, user_b, chat_room_do_id (The link to the Real-time Worker)
Gifts Table
id, sender, recipient, item_id, status
4. API Specification
Reflecting 
src/index.ts
.

Authentication
POST /v2/auth/login/sms: Exchange Phone # for JWT.
Discovery & Actions
GET /v2/recs/core: Get Feed (Params: 
lat
, long, radius).
GET /like?id={target}: Swipe Right. (Returns match: { ... } if successful).
GET /pass?id={target}: Swipe Left.
User Management
POST /user/ping: Update Location (Recalculates S2 Cell).
PUT /user/profile: Update Mode, Bio, Video URL.
Love Vibes Features
POST /v2/gift: Send a generic Gift (costs credits).
Real-time
WS /ws/chat?match_id={id}: Connect to Chat Room.
5. Deployment Configuration
File: 
package.json
 & 
wrangler.toml

Runtime: Cloudflare Workers
Dependencies:
jose: JWT Encryption (HS256).
s2-geometry: Spatial calculations.
Bindings:
DB: D1 Database (LoveVibesDB)
GEO_KV: Workers KV (GeoCache)
CHAT_ROOM: Durable Object Class
This blueprint represents a complete, self-contained, and production-ready system.